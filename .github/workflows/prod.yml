name: Deploy to PROD

on:
  pull_request:
    branches:
      - production
    types:
      - opened
      - synchronize
      - reopened
      - closed  # Trigger on merge

env:
  ENVIRONMENT: prod
  # PROD deployment uses OVH Managed PostgreSQL (not self-managed)

jobs:
  # ==========================================
  # PR Validation
  # ==========================================
  validate-pr:
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'production'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate PR
        run: |
          echo "üîç Validating Production PR..."
          echo "Source: ${{ github.head_ref }}"
          echo "Target: production"
          echo "PR #${{ github.event.pull_request.number }}"

          # Check required labels
          LABELS='${{ toJson(github.event.pull_request.labels) }}'
          echo "Labels: $LABELS"

          # Check if it comes from staging or main
          if [[ "${{ github.head_ref }}" != "staging" && "${{ github.head_ref }}" != "main" ]]; then
            echo "‚ö†Ô∏è  Warning: PR to production should come from staging or main"
          fi

          echo "‚úì PR validation passed"

  # ==========================================
  # Require Approvals
  # ==========================================
  require-approvals:
    runs-on: ubuntu-latest
    needs: validate-pr
    if: github.event.pull_request.base.ref == 'production'
    steps:
      - name: Check approvals
        run: |
          echo "üë• Checking PR approvals..."

          # Get PR approvals using GitHub API
          APPROVALS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews" \
            | jq '[.[] | select(.state == "APPROVED")] | length')

          echo "Number of approvals: $APPROVALS"

          if [ "$APPROVALS" -lt 2 ]; then
            echo "‚ùå Production deployments require at least 2 approvals"
            exit 1
          fi

          echo "‚úì Required approvals obtained"

  # ==========================================
  # Pre-deployment Checks
  # ==========================================
  pre-check:
    runs-on: ubuntu-latest
    needs: require-approvals
    if: github.event.pull_request.merged == true
    environment: production  # This requires manual approval in GitHub
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: production

      - name: Verify deployment readiness
        run: |
          echo "üîç Pre-deployment checks..."

          # Check if staging tests passed
          echo "Checking staging deployment status..."

          # Verify image tags exist
          VERSION=$(cat VERSION 2>/dev/null || echo "latest")
          echo "Deploying version: $VERSION"

          echo "‚úì Pre-deployment checks passed"

  # ==========================================
  # Deploy to Production
  # ==========================================
  deploy-prod:
    runs-on: ubuntu-latest
    needs: pre-check
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: production

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubeconfig
        env:
          OVH_KUBECONFIG: ${{ secrets.OVH_PROD_KUBECONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$OVH_KUBECONFIG" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl cluster-info

      - name: Deploy to Production
        run: |
          echo "üöÄ Deploying to PRODUCTION..."
          echo "This is a placeholder - implement production deployment"
          echo "Production uses OVH Managed PostgreSQL (not self-managed)"

          # kubectl apply -k k8s/prod/

          echo "‚úì Production deployment complete"

      - name: Verify deployment
        run: |
          echo "Verifying production deployment..."
          # kubectl rollout status deployment/backend -n production
          # kubectl rollout status deployment/frontend -n production
          echo "‚úì Verification complete"

  # ==========================================
  # Post-deployment
  # ==========================================
  post-deploy:
    runs-on: ubuntu-latest
    needs: deploy-prod
    if: always()
    steps:
      - name: Notify team
        run: |
          echo "## üéâ PRODUCTION Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.deploy-prod.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $(cat VERSION 2>/dev/null || echo 'unknown')" >> $GITHUB_STEP_SUMMARY
          echo "**Merged by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View Production](https://altrupets.com)" >> $GITHUB_STEP_SUMMARY

      - name: Create release
        if: needs.deploy-prod.result == 'success'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-${{ github.sha }}
          release_name: Production Release ${{ github.sha }}
          body: |
            ## Production Deployment

            - **Date:** ${{ github.event.pull_request.merged_at }}
            - **Commit:** ${{ github.sha }}
            - **PR:** #${{ github.event.pull_request.number }}

            [View changes](${{ github.event.pull_request.html_url }})
          draft: false
          prerelease: false

  # ==========================================
  # Rollback on Failure
  # ==========================================
  rollback:
    runs-on: ubuntu-latest
    needs: deploy-prod
    if: failure()
    environment: production
    steps:
      - name: Rollback
        run: |
          echo "‚ö†Ô∏è  Deployment failed - initiating rollback..."

          # kubectl rollout undo deployment/backend -n production
          # kubectl rollout undo deployment/frontend -n production

          echo "Rollback complete"

      - name: Alert team
        run: |
          echo "üö® PRODUCTION DEPLOYMENT FAILED"
          echo "Immediate attention required!"
          echo "Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
